name: Build and Test

# We are a reusable Workflow only
on:
  workflow_call:
  push:
    branches-ignore:
        - main
        - master
  pull_request:
    branches-ignore:
        - main
        - master

jobs:
  build:
    name: Maven Build
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '__CI__')"
    strategy:
      fail-fast: false
      matrix:
        lucee_version: ["6.0.0.346-BETA"]
        java_version: [ "8", "11", "17" ]

    steps:
    - uses: actions/checkout@v3

    - name: Set up JDK
      uses: actions/setup-java@v3
      with:
        java-version: '${{matrix.java_version}}'
        distribution: 'temurin'

    - name: Build with Maven
      run: mvn --batch-mode -f pom.xml -Dlucee.version=${{matrix.lucee_version}} -Djdk.version=${{matrix.java_version}} package

    - name: Setup Java
      uses: actions/setup-java@v3.9.0
      with:
        distribution: "temurin"
        java-version: "11"

    - name: Setup CommandBox CLI
      uses: Ortus-Solutions/setup-commandbox@main

    - name: Install Dependencies
      run: |
        box install
        box uninstall --system commandbox-dotenv

    - name: Start Application Server
      run: |
        cp .env.template .env
        box server start cfengine=lucee@${{matrix.lucee_version}} --dryRun --noSaveSettings --debug

    - name: Deploy Package
      run: |
        box cp target/*.lex .engine/lucee5/WEB-INF/lucee-server/deploy
        box server restart
        sleep 10s
        box server restart
        sleep 10s

    - name: Run Tests
      run: |
        mkdir -p tests/results
        box testbox run --verbose outputFile=tests/results/test-results outputFormats=json,antjunit

    - name: Publish Test Results
      uses: EnricoMi/publish-unit-test-result-action@v1
      if: always()
      with:
        files: tests/results/**/*.xml
        check_name: "${{ env.BRANCH }} Test Results"