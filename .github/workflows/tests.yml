name: Test

on:
  workflow_call:
    secrets:
      SLACK_WEBHOOK_URL:
        required: false
  push:
    branches-ignore:
        - main
        - master
        - development
        - release/**

jobs:
  test:
    name: Maven Build and Test
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[ci skip]')"
    continue-on-error: ${{ matrix.experimental }}
    strategy:
      fail-fast: false
      matrix:
        # We can run tests against any Lucee version, but we can only compile against Lucee releases available on mvnrepository.com.
        lucee_version: [ "5" ]
        java_version: [ "8", "11" ]
        experimental: [ false ]
        include:
          - lucee_version: "6"
            java_version: "21"
            experimental: false
          - lucee_version: "7"
            java_version: "21"
            experimental: true

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: "${{matrix.java_version}}"
        distribution: "temurin"
    # work around cfconfig incompatability between 5 and 6
    - name: Set H2_CUSTOM for Lucee 5
      if: ${{ matrix.lucee_version == '5' }}
      run: |
        H2_DBFILE=$(grep '^H2_DBFILE=' .env.template | cut -d '=' -f2)
        echo "H2_DBFILE=$H2_DBFILE" >> $GITHUB_ENV
        echo "H2_CUSTOM=&mode=MySQL&path=${H2_DBFILE}:" >> $GITHUB_ENV
    - name: Unset H2_CUSTOM for Lucee 6+
      if: ${{ matrix.lucee_version != '5' }}
      run: echo "H2_CUSTOM=" >> $GITHUB_ENV
    - name: Cache Maven packages
      if: always()
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: maven-cache
    - name: Setup CommandBox CLI
      uses: Ortus-Solutions/setup-commandbox@main

    - name: Install Dependencies
      run: box install

    - name: Start Application Server
      run: |
        cp .env.template .env
        box server start cfengine=lucee-light@${{matrix.lucee_version}} --noSaveSettings --debug

    - name: Build with Maven
      # TODO: Build against Lucee versions in case loader ever changes 
      # `-Dlucee.version=${{matrix.lucee_version}} `
      run: mvn --batch-mode -f pom.xml -Djdk.version=${{matrix.java_version}} -Dmaven.javadoc.skip=true package

    - name: Deploy Package
      run: |
        cp target/*.lex .engine/lucee5/WEB-INF/lucee-server/deploy
        box server restart
        sleep 10s
        box server restart
        sleep 10s

    - name: Run Tests
      run: |
        mkdir -p tests/results
        box testbox run --verbose outputFile=tests/results/test-results outputFormats=json,antjunit

    - name: Publish Test Results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: tests/results/**/*.xml
        check_name: "Test Results - Lucee ${{matrix.lucee_version}} on JRE ${{matrix.java_version}}"
